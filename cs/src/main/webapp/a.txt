
<script>
	var products = [ {
		productid : '1',
		name : '残联自收'
	}, {
		productid : '2',
		name : '地税代征'
	}, ];
	function productFormatter(value) {
		for ( var i = 0; i < products.length; i++) {
			if (products[i].productid == value)
				return products[i].name;
		}
		return value;
	}
	$(function() {
		var lastIndex;
		$('#tt').datagrid({
			toolbar : [ {
				text : '新建',
				iconCls : 'icon-add',
				handler : function() {
					$('#tt').datagrid('endEdit', lastIndex);
					$('#tt').datagrid('appendRow', {
						'paymentCompany.id' : '${entity.company.id}',
						auditId : '${entity.id}',
						version : '1',
						paymentDate : '',
						paymentBill : '',
						paymentMoney : '',
						'paymentPerson.id' : '',
						paymentType : '',
						remark : '55'
					});
					lastIndex = $('#tt').datagrid('getRows').length - 1;
					$('#tt').datagrid('selectRow', lastIndex);
					$('#tt').datagrid('beginEdit', lastIndex);
				}
			}, '-', {
				text : '删除',
				iconCls : 'icon-remove',
				handler : function() {
					var row = $('#tt').datagrid('getSelected');
					if (row) {
						var index = $('#tt').datagrid('getRowIndex', row);
						$('#tt').datagrid('deleteRow', index);
					}
				}
			}, '-', {
				text : '保存',
				iconCls : 'icon-save',
				handler : function() {
					$('#tt').datagrid('acceptChanges');
					var row = $('#tt').datagrid('getSelected');
					$.ajax({
						url : '${contextPath }/security/payment/confirm',
						type : 'post',
						data : row,
						success : function(data) {
							alert(data);
						},
						error : function() {
							alert("请求错误");
						},
						dataType : "json",
						async : false
					});

				}
			}, '-', {
				text : '撤消',
				iconCls : 'icon-undo',
				handler : function() {
					$('#tt').datagrid('rejectChanges');
				}
			}, '-', {
				text : '取得新建行数',
				iconCls : 'icon-search',
				handler : function() {
					var rows = $('#tt').datagrid('getChanges');
					alert('新建: ' + rows.length + ' 行');
				}
			} ],
			onBeforeLoad : function() {
				$(this).datagrid('rejectChanges');
			},
			onClickRow : function(rowIndex) {
				alert("ff");
				if (lastIndex != rowIndex) {
					$('#tt').datagrid('endEdit', lastIndex);
					$('#tt').datagrid('beginEdit', rowIndex);
				}
				lastIndex = rowIndex;
			}
		});
	});
</script>

<table id="tt" style="height:auto" data-options="iconCls:'icon-edit',singleSelect:true,idField:'itemid',url:'payment/getPayment/${entity.id}'" title="缴款记录">
	<thead>
		<tr>
			<th data-options="field:'paymentDate',width:100,editor:{type:'datebox',options:{height:30}}">缴款日期</th>
			<th data-options="field:'paymentBill',width:150,editor:'text'">票据号</th>
			<th data-options="field:'paymentMoney',width:120,editor:{type:'numberbox',options:{min:0,precision:2}}">缴款金额</th>
			<th data-options="field:'paymentPerson.id',width:100,editor:'text'">缴款人</th>
			<th
				data-options="field:'paymentType',width:100,formatter:productFormatter,  
                        editor:{  
                            type:'combobox',  
                            options:{  
                                valueField:'productid',  
                                textField:'name',  
                                data:products,  
                                required:true,  
                                height:30
                            }  
                        }">缴款方式</th>
			<th data-options="field:'remark',width:250,editor:'text'">备注</th>
		</tr>
	</thead>
</table>